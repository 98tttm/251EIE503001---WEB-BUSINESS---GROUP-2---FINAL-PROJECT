<div class="product-detail-container">
  @if (loading()) {
    <div class="loading">Đang tải sản phẩm...</div>
  } @else if (product()) {
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
      <a [routerLink]="['/']">Trang chủ</a>
      @for (cat of breadcrumb(); track cat._id) {
        <span class="separator">/</span>
        <a [routerLink]="['/category', cat.slug]">{{ cat.name }}</a>
      }
    </nav>

    <!-- Main Product Section -->
    <div class="product-main">
      <!-- Left: Image Gallery -->
      <div class="product-gallery">
        <!-- Main Image -->
        <div class="main-image">
          @if (allImages().length > 1) {
            <button class="main-image-nav prev" (click)="selectImage(selectedImage() === 0 ? allImages().length - 1 : selectedImage() - 1)">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M15 18l-6-6 6-6"/>
              </svg>
            </button>
          }
          
          <img [src]="allImages()[selectedImage()]" [alt]="product()!.name" (click)="openImageModal(selectedImage())" 
               loading="eager" decoding="async"
               (error)="$event.target.src = '/assets/images/icon/logo_tròn.png'; $event.target.onerror = null;"
               onerror="this.onerror=null; this.src='/assets/images/icon/logo_tròn.png';">
          
          @if (allImages().length > 1) {
            <button class="main-image-nav next" (click)="selectImage(selectedImage() === allImages().length - 1 ? 0 : selectedImage() + 1)">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M9 18l6-6-6-6"/>
              </svg>
            </button>
          }
        </div>

        <!-- Thumbnails -->
        <div class="thumbnails-wrapper">
          <div class="thumbnails">
            @for (img of allImages().slice(0, 4); track $index) {
              @let isLast = $index === 3 && allImages().length > 4;
              
              <button 
                class="thumbnail" 
                [class.active]="selectedImage() === $index"
                [class.has-overlay]="isLast"
                (click)="isLast ? openImageModal(0) : selectImage($index)">
                <img [src]="img" [alt]="'Ảnh ' + ($index + 1)" loading="lazy" decoding="async"
                     (error)="$event.target.src = '/assets/images/icon/logo_tròn.png'; $event.target.onerror = null;"
                     onerror="this.onerror=null; this.src='/assets/images/icon/logo_tròn.png';">
                @if (isLast) {
                  <div class="thumbnail-overlay">
                    <span class="overlay-text">Xem thêm<br>{{ allImages().length }} ảnh</span>
                  </div>
                }
              </button>
            }
          </div>
        </div>

        <p class="product-note">Mẫu mã sản phẩm có thể thay đổi theo lô hàng</p>
      </div>

      <!-- Right: Product Info -->
      <div class="product-info">
        <div class="brand-badge">Thương hiệu: <strong>{{ product()!.brand || 'NUTRIMED' }}</strong></div>
        
        <h1 class="product-title">{{ product()!.name }}</h1>

        <div class="product-meta">
          <span class="product-sku">{{ product()!._id }}</span>
          @if (reviews()) {
            <span class="rating">
              <span class="stars">★ {{ reviews()!.averageRating }}</span>
              <span class="review-count">{{ reviews()!.totalReviews }} đánh giá</span>
              <span class="comment-count">{{ reviews()!.totalComments }} bình luận</span>
            </span>
          }
        </div>

        <div class="product-pricing">
          <div class="price-main">
            <span class="price-current">{{ formatPrice(product()!.price) }}</span>
            <span class="price-unit">/ {{ product()!.unit || 'Hộp' }}</span>
          </div>
          @if (product()!.discount && product()!.discount! > 0) {
            <div class="price-original-row">
              <span class="price-original">{{ formatPrice(product()!.price + product()!.discount!) }}</span>
            </div>
          }
        </div>

        <!-- Product Details Table -->
        <div class="product-details-table">
          <!-- Unit Selection as first row -->
          <div class="detail-row">
            <span class="detail-label">Chọn đơn vị tính</span>
            <div class="detail-value unit-value">
              <button class="unit-btn active">{{ product()!.unit || 'Hộp' }}</button>
            </div>
          </div>
          
          @if (breadcrumb().length > 0) {
            <div class="detail-row">
              <span class="detail-label">Danh mục</span>
              <span class="detail-value link">
                <a [routerLink]="['/category', breadcrumb()[breadcrumb().length - 1].slug]">
                  {{ breadcrumb()[breadcrumb().length - 1].name }}
                </a>
              </span>
            </div>
          }
          @if (product()!.registration_number) {
            <div class="detail-row">
              <span class="detail-label">Số đăng ký</span>
              <span class="detail-value">{{ product()!.registration_number }}</span>
            </div>
          }
          @if (product()!.country) {
            <div class="detail-row">
              <span class="detail-label">Nước sản xuất</span>
              <span class="detail-value">{{ product()!.country }}</span>
            </div>
          }
          @if (product()!.dosage_form) {
            <div class="detail-row">
              <span class="detail-label">Dạng bào chế</span>
              <span class="detail-value">{{ product()!.dosage_form }}</span>
            </div>
          }
          @if (product()!.manufacturer) {
            <div class="detail-row">
              <span class="detail-label">Nhà sản xuất</span>
              <span class="detail-value">{{ product()!.manufacturer }}</span>
            </div>
          }
          @if (product()!.ingredients) {
            <div class="detail-row expand">
              <span class="detail-label">Thành phần</span>
              <span class="detail-value ingredients-preview">
                {{ product()!.ingredients }}
              </span>
            </div>
          }
        </div>

        <!-- Promotion Box (if discount exists) -->
        @if (product()!.discount && product()!.discount! > 0) {
          <div class="promotion-box">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
              <line x1="7" y1="7" x2="7.01" y2="7"/>
            </svg>
            <span>Khuyến mại được áp dụng</span>
          </div>
        }

        <!-- Quantity Selection -->
        <div class="quantity-section">
          <label>Chọn số lượng</label>
          <div class="quantity-control">
            <button class="qty-btn" (click)="decreaseQuantity()" [disabled]="quantity() === 1">-</button>
            <input type="number" [value]="quantity()" readonly class="qty-input">
            <button class="qty-btn" (click)="increaseQuantity()">+</button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="btn-add-cart" (click)="addToCart()">Chọn mua</button>
          <button class="btn-find-pharmacy" (click)="findPharmacy()">Tư vấn với MeCa ngay</button>
        </div>

        <!-- Product Status -->
        <div class="product-status">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f39c12" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5"/>
            <path d="M2 12l10 5 10-5"/>
          </svg>
          <span>Sản phẩm đang được chú ý, có 16 người thêm vào giỏ hàng & 40 người đang xem</span>
        </div>

        <!-- Benefits -->
        <div class="benefits-grid">
          <div class="benefit-item">
            <img src="/assets/images/icon/pack.png" alt="Đổi trả" width="40" height="40">
            <div>
              <strong>Đổi trả trong 30 ngày</strong>
              <p>kể từ ngày mua hàng</p>
            </div>
          </div>
          <div class="benefit-item">
            <img src="/assets/images/icon/trade.png" alt="Đổi thuốc" width="40" height="40">
            <div>
              <strong>Miễn phí 100%</strong>
              <p>đổi thuốc</p>
            </div>
          </div>
          <div class="benefit-item">
            <img src="/assets/images/icon/delivery.png" alt="Vận chuyển" width="40" height="40">
            <div>
              <strong>Miễn phí vận chuyển</strong>
              <p>theo chính sách giao hàng</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Description -->
    <div class="product-description">
      <h2 class="section-title">Thông tin chi tiết</h2>
      
      <div class="description-layout">
        <!-- Sidebar Navigation -->
        <div class="description-sidebar">
          <button 
            class="nav-item" 
            [class.active]="activeSection() === 'overview'"
            (click)="scrollToSection('overview')">
            Tổng quan
          </button>
          <button 
            class="nav-item" 
            [class.active]="activeSection() === 'ingredients'"
            (click)="scrollToSection('ingredients')">
            Thành phần
          </button>
          <button 
            class="nav-item" 
            [class.active]="activeSection() === 'usage'"
            (click)="scrollToSection('usage')">
            Công dụng
          </button>
          <button 
            class="nav-item" 
            [class.active]="activeSection() === 'howToUse'"
            (click)="scrollToSection('howToUse')">
            Cách dùng
          </button>
          <button 
            class="nav-item" 
            [class.active]="activeSection() === 'warnings'"
            (click)="scrollToSection('warnings')">
            Lưu ý & Cảnh báo
          </button>
          <button 
            class="nav-item" 
            [class.active]="activeSection() === 'storage'"
            (click)="scrollToSection('storage')">
            Bảo quản
          </button>
        </div>

        <!-- Content Area -->
        <div class="description-content" #descriptionContent (scroll)="onContentScroll()">
          <!-- Overview Section -->
          <div id="overview" class="content-section">
            <h3>{{ product()!.name }}</h3>
            <div class="info-box">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0066cc" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </svg>
              <p>Thực phẩm bảo vệ sức khỏe, không phải là thuốc, không có tác dụng thay thế thuốc chữa bệnh.</p>
            </div>
            <div class="description-text" [innerHTML]="processHtmlContent(product()!.description || 'Sản phẩm chất lượng cao, an toàn cho sức khỏe.')"></div>
          </div>

          <!-- Ingredients Section -->
          <div id="ingredients" class="content-section">
            <h3>Thành phần</h3>
            @if (product()!.ingredients) {
              <div class="description-text" [innerHTML]="processHtmlContent(product()!.ingredients)"></div>
            } @else {
              <table class="ingredients-table">
                <thead>
                  <tr>
                    <th>Thông tin thành phần</th>
                    <th>Hàm lượng</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td>Thành phần chính</td><td>Xem chi tiết trên bao bì</td></tr>
                </tbody>
              </table>
            }
          </div>

          <!-- Usage Section -->
          <div id="usage" class="content-section">
            <h3>Công dụng</h3>
            <div class="description-text" [innerHTML]="processHtmlContent(product()!.usage || 'Sản phẩm hỗ trợ sức khỏe hiệu quả.')"></div>
          </div>

          <!-- How to Use Section -->
          <div id="howToUse" class="content-section">
            <h3>Cách dùng</h3>
            <div class="description-text" [innerHTML]="processHtmlContent(product()!.dosage_form || 'Sử dụng theo chỉ dẫn của bác sĩ hoặc dược sĩ.')"></div>
            <p class="description-text"><strong>Lưu ý:</strong> Đọc kỹ hướng dẫn sử dụng trước khi dùng.</p>
          </div>

          <!-- Warnings Section -->
          <div id="warnings" class="content-section">
            <h3>Lưu ý & Cảnh báo</h3>
            <div class="description-text" [innerHTML]="processHtmlContent(product()!.warnings || 'Không sử dụng cho người mẫn cảm với bất kỳ thành phần nào của sản phẩm.')"></div>
            @if (product()!.prescriptionRequired) {
              <div class="warning-box">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <p><strong>Thuốc kê đơn:</strong> Chỉ sử dụng khi có chỉ định của bác sĩ.</p>
              </div>
            }
          </div>

          <!-- Storage Section -->
          <div id="storage" class="content-section">
            <h3>Bảo quản</h3>
            <p class="description-text">Bảo quản nơi khô ráo, thoáng mát, tránh ánh sáng trực tiếp.</p>
            <p class="description-text">Để xa tầm tay trẻ em.</p>
            <p class="description-text">Không sử dụng sau ngày hết hạn.</p>
          </div>

          <!-- Pharmacist Info -->
          <div class="pharmacist-info">
            <img src="/assets/images/icon/duocsiThinh.jpg" alt="Dược sĩ" class="pharmacist-avatar">
            <div class="pharmacist-details">
              <h4>Dược sĩ Đại học Trần Thanh Thịnh</h4>
              <p>Tốt nghiệp Khoa Dược trường Đại học Y Dược TP.HCM. Có nhiều năm kinh nghiệm công tác trong lĩnh vực Dược phẩm. Hiện đang giảng viên cho Dược sĩ tại Nhà thuốc MediCare.</p>
              <a href="#" class="link">Xem thêm thông tin ›</a>
            </div>
            <div class="verified-badge">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="#27ae60">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01" stroke="white" stroke-width="2" fill="none"/>
              </svg>
              Đã kiểm duyệt nội dung
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Related Products -->
    @if (relatedProducts().length > 0) {
      <div class="related-products">
        <h2 class="section-title">Sản phẩm liên quan</h2>
        <div class="slider-container">
          @if (relatedProducts().length > 5) {
            <button class="slider-btn prev" (click)="prevSlideRelated()" [disabled]="currentSlideRelated() === 0">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
              </svg>
            </button>
            <button class="slider-btn next" (click)="nextSlideRelated()" [disabled]="currentSlideRelated() >= relatedProducts().length - 5">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6"/>
              </svg>
            </button>
          }
          <div class="slider-wrapper">
            <div class="products-slider" [style.transform]="'translateX(-' + (currentSlideRelated() * getSlideWidthRelated()) + 'px)'">
              @for (product of relatedProducts(); track product._id) {
                <div class="product-card">
                  <!-- Discount Badge -->
                  @if (product.discount && product.discount > 0) {
                    <div class="discount-badge">-{{ calculateDiscountPercent(product.price, product.discount) }}%</div>
                  }
                  
                  <!-- Product Image -->
                  <a [routerLink]="['/product', product._id]" class="product-image">
                    <img [src]="product.image || '/assets/images/icon/logo_tròn.png'" [alt]="product.name">
                  </a>
                  
                  <!-- Product Info -->
                  <div class="product-info">
                    <a [routerLink]="['/product', product._id]" class="product-name">
                      {{ product.name }}
                    </a>
                    
                    <!-- Product Pricing -->
                    <div class="product-pricing">
                      <div class="price-row">
                        <span class="product-price">{{ formatPrice(product.discount && product.discount > 0 ? product.price : product.price) }}</span>
                        <span class="product-unit">/ {{ product.unit || 'Hộp' }}</span>
                      </div>
                      @if (product.discount && product.discount > 0) {
                        <div class="product-original-price">{{ formatPrice(product.price + product.discount) }}</div>
                      }
                    </div>
                    
                    <!-- Add to Cart Button -->
                    <button class="btn-add-cart" (click)="addToCartQuick(product)">Chọn mua</button>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Reviews Section -->
    <div class="reviews-section">
      @if (reviews()) {
        <h2 class="section-title">Đánh giá sản phẩm ({{ reviews()!.totalReviews }} đánh giá)</h2>
        <div class="reviews-summary">
          <div class="rating-overview">
            <div class="rating-score">{{ reviews()!.averageRating || 0 }} ★</div>
            <button class="btn-write-review" (click)="openRatingForm()">Gửi đánh giá</button>
          </div>
          <div class="rating-bars">
            <div class="rating-bar">
              <span>★★★★★</span>
              <div class="bar"><div class="fill" [style.width.%]="reviews()!.totalReviews > 0 ? (reviews()!.ratingDistribution[5] / reviews()!.totalReviews * 100) : 0"></div></div>
              <span>{{ reviews()!.ratingDistribution[5] }}</span>
            </div>
            <div class="rating-bar">
              <span>★★★★☆</span>
              <div class="bar"><div class="fill" [style.width.%]="reviews()!.totalReviews > 0 ? (reviews()!.ratingDistribution[4] / reviews()!.totalReviews * 100) : 0"></div></div>
              <span>{{ reviews()!.ratingDistribution[4] }}</span>
            </div>
            <div class="rating-bar">
              <span>★★★☆☆</span>
              <div class="bar"><div class="fill" [style.width.%]="reviews()!.totalReviews > 0 ? (reviews()!.ratingDistribution[3] / reviews()!.totalReviews * 100) : 0"></div></div>
              <span>{{ reviews()!.ratingDistribution[3] }}</span>
            </div>
            <div class="rating-bar">
              <span>★★☆☆☆</span>
              <div class="bar"><div class="fill" [style.width.%]="reviews()!.totalReviews > 0 ? (reviews()!.ratingDistribution[2] / reviews()!.totalReviews * 100) : 0"></div></div>
              <span>{{ reviews()!.ratingDistribution[2] }}</span>
            </div>
            <div class="rating-bar">
              <span>★☆☆☆☆</span>
              <div class="bar"><div class="fill" [style.width.%]="reviews()!.totalReviews > 0 ? (reviews()!.ratingDistribution[1] / reviews()!.totalReviews * 100) : 0"></div></div>
              <span>{{ reviews()!.ratingDistribution[1] }}</span>
            </div>
          </div>
        </div>

        <!-- Rating Form -->
        @if (showRatingForm()) {
          <div class="rating-form">
            <div class="form-header">
              <div class="user-info">
                <div class="user-avatar-form">
                  {{ (authService.currentUser()?.name || authService.currentUser()?.email || 'U').charAt(0).toUpperCase() }}
                </div>
                <div>
                  <h3>Gửi đánh giá của bạn</h3>
                  <p class="user-display-name">{{ authService.currentUser()?.name || authService.currentUser()?.email }}</p>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>Chọn số sao:</label>
              <div class="star-rating">
                @for (star of [1, 2, 3, 4, 5]; track star) {
                  <button 
                    class="star-btn" 
                    [class.active]="selectedRating() >= star"
                    (click)="selectedRating.set(star)">
                    ★
                  </button>
                }
              </div>
            </div>
            
            <div class="form-group">
              <label>Nhận xét (tùy chọn):</label>
              <textarea 
                [(ngModel)]="ratingComment" 
                placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm này..."
                class="form-textarea"
                rows="3"></textarea>
            </div>
            
            <div class="form-actions">
              <button class="btn-submit" (click)="submitRating()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                Gửi đánh giá
              </button>
              <button class="btn-cancel" (click)="showRatingForm.set(false)">Hủy</button>
            </div>
          </div>
        }

        <div class="review-filters">
          <button 
            class="filter-btn" 
            [class.active]="selectedRatingFilter() === 'all'"
            (click)="filterRatings('all')">Tất cả</button>
          <button 
            class="filter-btn" 
            [class.active]="selectedRatingFilter() === '5'"
            (click)="filterRatings('5')">5 sao</button>
          <button 
            class="filter-btn" 
            [class.active]="selectedRatingFilter() === '4'"
            (click)="filterRatings('4')">4 sao</button>
          <button 
            class="filter-btn" 
            [class.active]="selectedRatingFilter() === '3'"
            (click)="filterRatings('3')">3 sao</button>
          <button 
            class="filter-btn" 
            [class.active]="selectedRatingFilter() === '2'"
            (click)="filterRatings('2')">2 sao</button>
          <button 
            class="filter-btn" 
            [class.active]="selectedRatingFilter() === '1'"
            (click)="filterRatings('1')">1 sao</button>
        </div>

        <div class="reviews-list">
          @if (ratings().length === 0) {
            <p class="no-reviews">Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá sản phẩm này!</p>
          }
          @for (rating of visibleRatings; track rating._id) {
            <div>
              <div class="review-item">
                <div class="reviewer-avatar">{{ rating.userName.charAt(0).toUpperCase() }}</div>
                <div class="review-content">
                  <h4>{{ rating.userName }}</h4>
                  <div class="review-rating">{{ rating.rating }} ★</div>
                  @if (rating.userComment) {
                    <p class="review-text">{{ rating.userComment }}</p>
                  }
                  <div class="review-footer">
                    <span class="review-date">{{ formatDate(rating.createdAt) }}</span>
                    <button class="reply-btn" (click)="showRatingReplyForm(rating._id!)">Trả lời</button>
                  </div>
                </div>
              </div>
              
              <!-- Replies -->
              @if (rating.replies && rating.replies.length > 0) {
                <div class="replies-container">
                  @for (reply of rating.replies; track reply._id) {
                    <div class="reply-item">
                      <div class="reply-avatar">{{ reply.userName.charAt(0).toUpperCase() }}</div>
                      <div class="reply-content">
                        <h5>{{ reply.userName }}</h5>
                        <p>{{ reply.content }}</p>
                        <span class="reply-date">{{ formatDate(reply.createdAt) }}</span>
                      </div>
                    </div>
                  }
                </div>
              }
              
              <!-- Reply Form -->
              @if (replyingToRatingId() === rating._id) {
                <div class="reply-form-container">
                  <div class="reply-form-header">
                    Đang trả lời: <strong>{{ rating.userName }}</strong>
                  </div>
                  <textarea 
                    class="reply-input"
                    [(ngModel)]="ratingReplyContent"
                    placeholder="Nhập nội dung trả lời..."></textarea>
                  <div class="reply-form-actions">
                    <button class="reply-submit-btn" (click)="submitRatingReply(rating._id!, rating.userName)">
                      Gửi trả lời
                    </button>
                    <button class="reply-cancel-btn" (click)="cancelRatingReply()">Hủy</button>
                  </div>
                </div>
              }
            </div>
          }
        </div>
        
        @if (hasMoreRatings) {
          <button class="load-more-btn" (click)="loadMoreRatings()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            Xem thêm 5 đánh giá
          </button>
        }
      }
    </div>

    <!-- Q&A Section -->
    <div class="qa-section">
      @if (reviews()) {
        <h2 class="section-title">Hỏi đáp ({{ reviews()!.totalComments }} bình luận)</h2>
        <button class="btn-write-comment" (click)="openCommentForm()">Gửi bình luận</button>
        
        <!-- Comment Form -->
        @if (showCommentForm()) {
          <div class="comment-form">
            <div class="form-header">
              <div class="user-info">
                <div class="user-avatar-form">
                  {{ (authService.currentUser()?.name || authService.currentUser()?.email || 'U').charAt(0).toUpperCase() }}
                </div>
                <div>
                  <h3>Gửi câu hỏi của bạn</h3>
                  <p class="user-display-name">{{ authService.currentUser()?.name || authService.currentUser()?.email }}</p>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>Câu hỏi / Bình luận:</label>
              <textarea 
                [(ngModel)]="commentContent" 
                placeholder="Chia sẻ câu hỏi hoặc trải nghiệm của bạn về sản phẩm này..."
                class="form-textarea"
                rows="4"></textarea>
            </div>
            
            <div class="form-actions">
              <button class="btn-submit" (click)="submitComment()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                Gửi bình luận
              </button>
              <button class="btn-cancel" (click)="showCommentForm.set(false)">Hủy</button>
            </div>
          </div>
        }
        
        <div class="qa-filters">
          <button 
            class="filter-btn" 
            [class.active]="commentSortBy() === 'newest'"
            (click)="sortComments('newest')">Mới nhất</button>
          <button 
            class="filter-btn" 
            [class.active]="commentSortBy() === 'oldest'"
            (click)="sortComments('oldest')">Cũ nhất</button>
          <button 
            class="filter-btn" 
            [class.active]="commentSortBy() === 'helpful'"
            (click)="sortComments('helpful')">Hữu ích nhất</button>
        </div>

        <div class="qa-list">
          @if (comments().length === 0) {
            <p class="no-comments">Chưa có câu hỏi nào. Hãy là người đầu tiên đặt câu hỏi về sản phẩm này!</p>
          }
          @for (comment of visibleComments; track comment._id) {
            <div>
              <div class="qa-item">
                <div class="user-avatar">{{ comment.userName.substring(0, 2).toUpperCase() }}</div>
                <div class="qa-content">
                  <h4>{{ comment.userName }}</h4>
                  <p>{{ comment.content }}</p>
                  <div class="qa-actions">
                    <span class="qa-date">{{ formatDate(comment.createdAt) }}</span>
                    <button 
                      class="helpful-btn" 
                      [class.active]="isCommentHelpful(comment)"
                      (click)="toggleHelpful(comment._id!)">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                      </svg>
                      Hữu ích ({{ comment.helpfulCount }})
                    </button>
                    <button class="reply-btn" (click)="showReplyForm(comment._id!)">Trả lời</button>
                  </div>
                </div>
              </div>
              
              <!-- Replies -->
              @if (comment.replies && comment.replies.length > 0) {
                <div class="replies-container">
                  @for (reply of comment.replies; track reply._id) {
                    <div class="reply-item">
                      <div class="reply-avatar">{{ reply.userName.charAt(0).toUpperCase() }}</div>
                      <div class="reply-content">
                        <h5>{{ reply.userName }}</h5>
                        <p>{{ reply.content }}</p>
                        <span class="reply-date">{{ formatDate(reply.createdAt) }}</span>
                      </div>
                    </div>
                  }
                </div>
              }
              
              <!-- Reply Form -->
              @if (replyingToCommentId() === comment._id) {
                <div class="reply-form-container">
                  <div class="reply-form-header">
                    Đang trả lời: <strong>{{ comment.userName }}</strong>
                  </div>
                  <textarea 
                    class="reply-input"
                    [(ngModel)]="replyContent"
                    placeholder="Nhập nội dung trả lời..."></textarea>
                  <div class="reply-form-actions">
                    <button class="reply-submit-btn" (click)="submitReply(comment._id!, comment.userName)">
                      Gửi bình luận
                    </button>
                    <button class="reply-cancel-btn" (click)="cancelReply()">Hủy</button>
                  </div>
                </div>
              }
            </div>
          }
        </div>
        
        @if (hasMoreComments) {
          <button class="load-more-btn" (click)="loadMoreComments()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            Xem thêm 5 bình luận
          </button>
        }
      }
    </div>

    <!-- Recently Viewed -->
    @if (recentlyViewed().length > 0) {
      <div class="recently-viewed">
        <h2 class="section-title">Sản phẩm vừa xem</h2>
        <div class="slider-container">
          @if (recentlyViewed().length > 5) {
            <button class="slider-btn prev" (click)="prevSlide()" [disabled]="currentSlide() === 0">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
              </svg>
            </button>
            <button class="slider-btn next" (click)="nextSlide()" [disabled]="currentSlide() >= recentlyViewed().length - 5">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6"/>
              </svg>
            </button>
          }
          <div class="slider-wrapper">
          <div class="products-slider" [style.transform]="'translateX(-' + (currentSlide() * getSlideWidth()) + 'px)'">
            @for (product of recentlyViewed(); track product._id) {
              <div class="product-card">
                <!-- Discount Badge -->
                @if (product.discount && product.discount > 0) {
                  <div class="discount-badge">-{{ calculateDiscountPercent(product.price, product.discount) }}%</div>
                }
                
                <!-- Product Image -->
                <a [routerLink]="['/product', product._id]" class="product-image">
                  <img [src]="product.image || '/assets/images/icon/logo_tròn.png'" [alt]="product.name">
                </a>
                
                <!-- Product Info -->
                <div class="product-info">
                  <a [routerLink]="['/product', product._id]" class="product-name">
                    {{ product.name }}
                  </a>
                  
                  <div class="product-pricing">
                    <span class="product-price">{{ formatPrice(product.price) }}</span>
                    @if (product.unit) {
                      <span class="product-unit">/ {{ product.unit }}</span>
                    }
                  </div>
                  
                  @if (product.discount && product.discount > 0) {
                    <div class="product-original-price">{{ formatPrice(product.price + product.discount) }}</div>
                  }
                  
                  <!-- Add to Cart Button -->
                  <button class="btn-add-cart" (click)="addToCartQuick(product)">Chọn mua</button>
                </div>
              </div>
            }
          </div>
          </div>
        </div>
      </div>
    }

  } @else {
    <div class="not-found">Không tìm thấy sản phẩm</div>
  }
</div>

<!-- Login Component -->
<app-login></app-login>

<!-- Image Modal -->
@if (showImageModal()) {
  <div class="image-modal-overlay" (click)="closeImageModal()">
    <div class="image-modal" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="modal-header">
        <h3 class="modal-product-name">{{ product()!.name }}</h3>
        <button class="modal-close" (click)="closeImageModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <!-- Left: Thumbnails -->
        <div class="modal-sidebar">
          <div class="modal-thumbnails-scroll">
            @for (img of allImages(); track $index) {
              <button 
                class="modal-thumbnail" 
                [class.active]="modalImageIndex() === $index"
                (click)="selectModalImage($index)">
                <img [src]="img" [alt]="'Ảnh ' + ($index + 1)">
              </button>
            }
          </div>
        </div>

        <!-- Right: Main Image -->
        <div class="modal-main-area">
          <!-- Image Container -->
          <div class="modal-image-container">
            @if (allImages().length > 1) {
              <!-- Previous Button -->
              <button class="modal-nav-btn prev" (click)="prevModalImage()">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <path d="M15 18l-6-6 6-6"/>
                </svg>
              </button>
            }

            <!-- Image -->
            <div class="modal-main-image">
              <img [src]="allImages()[modalImageIndex()]" [alt]="product()!.name" loading="eager" decoding="async"
                   (error)="$event.target.src = '/assets/images/icon/logo_tròn.png'; $event.target.onerror = null;"
                   onerror="this.onerror=null; this.src='/assets/images/icon/logo_tròn.png';">
            </div>

            @if (allImages().length > 1) {
              <!-- Next Button -->
              <button class="modal-nav-btn next" (click)="nextModalImage()">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
              </button>
            }
          </div>

          <!-- Image Counter -->
          <div class="modal-footer">
            <div class="modal-counter">
              {{ modalImageIndex() + 1 }} / {{ allImages().length }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
}

<!-- Success Popup -->
@if (showSuccessPopup()) {
  <div class="success-overlay" (click)="closeSuccessPopup()">
    <div class="success-modal" (click)="$event.stopPropagation()">
      <button class="success-close" (click)="closeSuccessPopup()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
      
      <div class="success-icon">
        <svg width="80" height="80" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" fill="#10b981" opacity="0.1"/>
          <circle cx="50" cy="50" r="40" fill="#10b981" opacity="0.2"/>
          <circle cx="50" cy="50" r="35" fill="#10b981"/>
          <path d="M30 50 L45 65 L70 35" stroke="white" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
      </div>
      
      <h3 class="success-title">
        @if (successType() === 'rating') {
          Gửi đánh giá thành công
        } @else {
          Gửi bình luận thành công
        }
      </h3>
      
      <p class="success-message">{{ successMessage() }}</p>
      
      <button class="success-btn" (click)="closeSuccessPopup()">
        Tiếp tục mua hàng
      </button>
    </div>
  </div>
}
