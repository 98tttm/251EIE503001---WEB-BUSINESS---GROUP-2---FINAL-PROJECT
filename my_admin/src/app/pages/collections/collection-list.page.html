<section class="collection" *ngIf="collectionMeta(); else missingCollection">
  <!-- Enhanced Header with Actions -->
  <header class="collection-header">
    <div class="header-content">
      <div class="header-title">
        <h2>
          <span class="collection-icon">üì¶</span>
          {{ collectionLabel }}
        </h2>
        <p>{{ collectionMeta()?.description || collectionLabel }}</p>
      </div>
      <div class="header-stats">
        <div class="stat-item">
          <span class="stat-label">T·ªïng s·ªë</span>
          <span class="stat-value">{{ pagination().total | number }}</span>
        </div>
        <div class="stat-item" *ngIf="isProductCollection()">
          <span class="stat-label">T·ªìn kho th·∫•p</span>
          <span class="stat-value warning">{{ lowStockCount() | number }}</span>
        </div>
        <div class="stat-item" *ngIf="isOrderCollection()">
          <span class="stat-label">Ch·ªù x·ª≠ l√Ω</span>
          <span class="stat-value pending">{{ orderStats()?.pending || 0 }}</span>
        </div>
      </div>
    </div>
    
    <div class="toolbar">
      <div class="search-box">
        <span class="material-icon">search</span>
        <input
          type="search"
          placeholder="T√¨m ki·∫øm theo t√™n, ID, SKU..."
          [value]="searchTerm()"
          (input)="onSearch($event.target.value)"
        />
        <button *ngIf="searchTerm()" (click)="clearSearch()" class="clear-search" type="button">
          <span class="material-icon">close</span>
        </button>
      </div>
      
      <div class="toolbar-actions">
        <button class="action-btn" type="button" (click)="toggleFilters()" [class.active]="showFilters()">
          <span class="material-icon">filter_list</span>
          <span>B·ªô l·ªçc</span>
          <span class="badge" *ngIf="activeFiltersCount() > 0">{{ activeFiltersCount() }}</span>
        </button>
        
        <button class="action-btn" type="button" (click)="exportData()" [disabled]="loading()">
          <span class="material-icon">download</span>
          <span>Xu·∫•t Excel</span>
        </button>
        
        <button class="action-btn" type="button" (click)="openImportModal()" *ngIf="collectionMeta()?.allowCreate">
          <span class="material-icon">upload</span>
          <span>Nh·∫≠p d·ªØ li·ªáu</span>
        </button>
        
        <!-- Special button for orders to create order on behalf of customer -->
        <button class="action-btn special" type="button" routerLink="/admin/create-order" *ngIf="isOrderCollection()">
          <span class="material-icon">add_shopping_cart</span>
          <span>ƒê·∫∑t h√†ng d√πm kh√°ch</span>
        </button>
        
        <button class="primary" type="button" (click)="goToCreate()" *ngIf="collectionMeta()?.allowCreate">
          <span class="material-icon">add</span>
          <span>Th√™m m·ªõi</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Quick Stats Summary -->
  <div class="summary-cards" *ngIf="!isPharmacistChatCollection() && !isOrderCollection()">
    <div class="summary-card">
      <span class="material-icon">inventory_2</span>
      <div class="summary-content">
        <span class="summary-label">ƒêang hi·ªÉn th·ªã</span>
        <span class="summary-value">{{ items().length }} / {{ pagination().total | number }}</span>
      </div>
    </div>
    <div class="summary-card" *ngIf="selected().size > 0">
      <span class="material-icon" style="color: #2563eb">check_circle</span>
      <div class="summary-content">
        <span class="summary-label">ƒê√£ ch·ªçn</span>
        <span class="summary-value">{{ selected().size }}</span>
      </div>
    </div>
  </div>

  <div class="alert" *ngIf="error()">
    <span class="material-icon">error</span>
    {{ error() }}
  </div>

  <!-- Enhanced Filters Panel -->
  <div class="filters-panel" *ngIf="showFilters()">
    <div class="filters-header">
      <h3>
        <span class="material-icon">tune</span>
        B·ªô l·ªçc n√¢ng cao
      </h3>
      <button type="button" class="ghost-btn" (click)="clearFilters()">
        <span class="material-icon">filter_alt_off</span>
        X√≥a t·∫•t c·∫£ b·ªô l·ªçc
      </button>
    </div>
    
    <div class="filters-content">
      <!-- Filters for products -->
      <ng-container *ngIf="isProductCollection()">
        <div class="filter-group">
          <label class="filter-label">
            <span class="material-icon">inventory</span>
            Tr·∫°ng th√°i t·ªìn kho
          </label>
          <div class="filter-buttons">
            <button 
              type="button" 
              class="filter-btn" 
              [class.active]="stockFilter() === 'all'"
              (click)="stockFilter.set('all')">
              T·∫•t c·∫£
            </button>
            <button 
              type="button" 
              class="filter-btn" 
              [class.active]="stockFilter() === 'in'"
              (click)="stockFilter.set('in')">
              C√≤n h√†ng
            </button>
            <button 
              type="button" 
              class="filter-btn" 
              [class.active]="stockFilter() === 'out'"
              (click)="stockFilter.set('out')">
              H·∫øt h√†ng
            </button>
          </div>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">
            <span class="material-icon">payments</span>
            Kho·∫£ng gi√°
          </label>
          <div class="price-range">
            <input 
              type="number" 
              placeholder="Gi√° t·ª´" 
              [ngModel]="minPrice()" 
              (ngModelChange)="minPrice.set($event)"
              class="price-input"
            />
            <span class="range-separator">‚Äî</span>
            <input 
              type="number" 
              placeholder="Gi√° ƒë·∫øn" 
              [ngModel]="maxPrice()" 
              (ngModelChange)="maxPrice.set($event)"
              class="price-input"
            />
          </div>
        </div>
      </ng-container>
      
      <!-- Filters for categories -->
      <ng-container *ngIf="isCategoryCollection()">
        <div class="filter-group">
          <label class="filter-label">
            <span class="material-icon">layers</span>
            C·∫•p ƒë·ªô danh m·ª•c
          </label>
          <div class="filter-buttons">
            <button 
              type="button" 
              class="filter-btn" 
              [class.active]="levelFilter() === null"
              (click)="levelFilter.set(null)">
              T·∫•t c·∫£
            </button>
            <button 
              type="button" 
              class="filter-btn" 
              [class.active]="levelFilter() === 1"
              (click)="levelFilter.set(1)">
              C·∫•p 1
            </button>
            <button 
              type="button" 
              class="filter-btn" 
              [class.active]="levelFilter() === 2"
              (click)="levelFilter.set(2)">
              C·∫•p 2
            </button>
            <button 
              type="button" 
              class="filter-btn" 
              [class.active]="levelFilter() === 3"
              (click)="levelFilter.set(3)">
              C·∫•p 3
            </button>
          </div>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">
            <span class="material-icon">visibility</span>
            Tr·∫°ng th√°i hi·ªÉn th·ªã
          </label>
          <div class="filter-buttons">
            <button 
              type="button" 
              class="filter-btn" 
              [class.active]="activeFilter() === 'all'"
              (click)="activeFilter.set('all')">
              T·∫•t c·∫£
            </button>
            <button 
              type="button" 
              class="filter-btn" 
              [class.active]="activeFilter() === 'active'"
              (click)="activeFilter.set('active')">
              Ho·∫°t ƒë·ªông
            </button>
            <button 
              type="button" 
              class="filter-btn" 
              [class.active]="activeFilter() === 'inactive'"
              (click)="activeFilter.set('inactive')">
              ·∫®n
            </button>
          </div>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Old Filters (Hidden) -->
  <div class="filters" *ngIf="false && isProductCollection()" style="display: none;">
    <div class="filter-item">
      <label>T·ªìn kho</label>
      <select [ngModel]="stockFilter()" (ngModelChange)="stockFilter.set($event)">
        <option value="all">T·∫•t c·∫£</option>
        <option value="in">C√≤n h√†ng</option>
        <option value="out">H·∫øt h√†ng</option>
      </select>
    </div>
    <div class="filter-item">
      <label>Gi√° t·ª´</label>
      <input type="number" placeholder="min" [ngModel]="minPrice()" (ngModelChange)="minPrice.set($event)" />
    </div>
    <div class="filter-item">
      <label>ƒë·∫øn</label>
      <input type="number" placeholder="max" [ngModel]="maxPrice()" (ngModelChange)="maxPrice.set($event)" />
    </div>
    <div class="filter-actions">
      <button type="button" class="ghost" (click)="clearFilters()">
        <span class="material-icon">filter_alt_off</span>
        B·ªè l·ªçc
      </button>
    </div>
  </div>

  <!-- Filters for categories -->
  <div class="filters" *ngIf="isCategoryCollection()">
    <div class="filter-item">
      <label>C·∫•p ƒë·ªô</label>
      <select [ngModel]="levelFilter()" (ngModelChange)="onLevelFilterChange($event)">
        <option value="">T·∫•t c·∫£</option>
        <option value="1">C·∫•p 1</option>
        <option value="2">C·∫•p 2</option>
        <option value="3">C·∫•p 3</option>
      </select>
    </div>
    <div class="filter-item">
      <label>Tr·∫°ng th√°i</label>
      <select [ngModel]="activeFilter()" (ngModelChange)="activeFilter.set($event)">
        <option value="all">T·∫•t c·∫£</option>
        <option value="active">Ho·∫°t ƒë·ªông</option>
        <option value="inactive">·∫®n</option>
      </select>
    </div>
    <div class="filter-actions">
      <button type="button" class="ghost" (click)="clearFilters()">
        <span class="material-icon">filter_alt_off</span>
        B·ªè l·ªçc
      </button>
    </div>
  </div>

  <!-- Order Stats Dashboard -->
  <div class="order-stats" *ngIf="isOrderCollection() && orderStats()">
    <div class="stat-card" 
         [class.active]="orderStatusFilter() === 'all'"
         (click)="setOrderStatusFilter('all')">
      <div class="stat-icon all">
        <span class="material-icon">shopping_cart</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ orderStats()!.total }}</div>
        <div class="stat-label">T·∫•t c·∫£</div>
      </div>
    </div>
    
    <div class="stat-card" 
         [class.active]="orderStatusFilter() === 'pending'"
         (click)="setOrderStatusFilter('pending')">
      <div class="stat-icon pending">
        <span class="material-icon">schedule</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ orderStats()!.pending }}</div>
        <div class="stat-label">Ch·ªù x·ª≠ l√Ω</div>
      </div>
    </div>
    
    <div class="stat-card" 
         [class.active]="orderStatusFilter() === 'processing'"
         (click)="setOrderStatusFilter('processing')">
      <div class="stat-icon processing">
        <span class="material-icon">hourglass_empty</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ orderStats()!.processing }}</div>
        <div class="stat-label">ƒêang x·ª≠ l√Ω</div>
      </div>
    </div>
    
    <div class="stat-card" 
         [class.active]="orderStatusFilter() === 'shipping'"
         (click)="setOrderStatusFilter('shipping')">
      <div class="stat-icon shipping">
        <span class="material-icon">local_shipping</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ orderStats()!.shipping }}</div>
        <div class="stat-label">ƒêang giao</div>
      </div>
    </div>
    
    <div class="stat-card" 
         [class.active]="orderStatusFilter() === 'delivered'"
         (click)="setOrderStatusFilter('delivered')">
      <div class="stat-icon delivered">
        <span class="material-icon">check_circle</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ orderStats()!.delivered }}</div>
        <div class="stat-label">ƒê√£ giao</div>
      </div>
    </div>
    
    <div class="stat-card" 
         [class.active]="orderStatusFilter() === 'cancelled'"
         (click)="setOrderStatusFilter('cancelled')">
      <div class="stat-icon cancelled">
        <span class="material-icon">cancel</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ orderStats()!.cancelled }}</div>
        <div class="stat-label">ƒê√£ h·ªßy</div>
      </div>
    </div>
    
    <div class="stat-card" 
         [class.active]="orderStatusFilter() === 'returned'"
         (click)="setOrderStatusFilter('returned')">
      <div class="stat-icon returned">
        <span class="material-icon">keyboard_return</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ orderStats()!.returned }}</div>
        <div class="stat-label">ƒê√£ tr·∫£</div>
      </div>
    </div>
  </div>

  <!-- Bulk selection bar -->
  <div class="bulk-bar" *ngIf="selected().size > 0">
    <span>ƒê√£ ch·ªçn {{ selected().size | number }} s·∫£n ph·∫©m</span>
    <div class="spacer"></div>
    <button type="button" class="ghost danger" (click)="deleteSelected()" *ngIf="collectionMeta()?.allowDelete">
      <span class="material-icon">delete</span>
      X√≥a ƒë√£ ch·ªçn
    </button>
    <button type="button" class="ghost" (click)="clearSelection()">
      <span class="material-icon">close</span>
      B·ªè ch·ªçn
    </button>
  </div>

  <!-- Specialized category table -->
  <div class="table-wrapper" *ngIf="isCategoryCollection() && !isEmpty()">
    <table class="category-table">
      <thead>
        <tr>
          <th class="name-col">T√™n danh m·ª•c</th>
          <th class="id-col">ID</th>
          <th class="slug-col">Slug</th>
          <th class="level-col">C·∫•p ƒë·ªô</th>
          <th class="parent-col">Danh m·ª•c cha</th>
          <th class="order-col">Th·ª© t·ª±</th>
          <th class="status-col">Tr·∫°ng th√°i</th>
          <th class="actions">H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let c of filteredCategories()" class="clickable-row category-row" [attr.data-level]="c.level" (click)="goToDetail(c.id)">
          <td class="name category-name">
            <div class="category-name-wrapper" [style.padding-left]="(c.level - 1) * 30 + 'px'">
              <span class="category-icon" *ngIf="c.icon">
                <span class="material-icon" *ngIf="!c.icon.startsWith('http')">{{ c.icon }}</span>
                <img *ngIf="c.icon.startsWith('http')" [src]="c.icon" alt="Icon" />
              </span>
              <span class="category-icon placeholder" *ngIf="!c.icon">
                <span class="material-icon">{{ c.level === 1 ? 'folder' : (c.level === 2 ? 'folder_open' : 'description') }}</span>
              </span>
              <span class="category-name-text">{{ c.name || '‚Äî' }}</span>
              <span class="children-count" *ngIf="getCategoryChildrenCount(c.id) > 0">
                {{ getCategoryChildrenCount(c.id) }}
              </span>
            </div>
          </td>
          <td class="mono id-col">{{ c.id.substring(0, 8) }}...</td>
          <td class="slug-col mono">{{ c.slug || '‚Äî' }}</td>
          <td class="level-col">
            <span class="level-badge" [class.level-1]="c.level === 1" [class.level-2]="c.level === 2" [class.level-3]="c.level === 3">
              <span class="material-icon">{{ c.level === 1 ? 'looks_one' : (c.level === 2 ? 'looks_two' : 'looks_3') }}</span>
              C·∫•p {{ c.level }}
            </span>
          </td>
          <td class="parent-col">
            <span *ngIf="!c.parentId" class="parent-none">‚Äî</span>
            <span *ngIf="c.parentName" class="parent-name">{{ c.parentName }}</span>
            <span *ngIf="c.parentId && !c.parentName" class="parent-id">{{ c.parentId.substring(0, 12) }}...</span>
          </td>
          <td class="order-col">
            <span class="order-value" *ngIf="c.displayOrder !== undefined && c.displayOrder !== null">{{ c.displayOrder }}</span>
            <span class="order-auto" *ngIf="c.displayOrder === undefined || c.displayOrder === null">Auto</span>
          </td>
          <td class="status-col">
            <span class="status-badge" [class.active]="c.isActive" [class.inactive]="!c.isActive">
              <span class="material-icon">{{ c.isActive ? 'check_circle' : 'cancel' }}</span>
              {{ c.isActive ? 'Ho·∫°t ƒë·ªông' : '·∫®n' }}
            </span>
          </td>
          <td class="actions" (click)="$event.stopPropagation()">
            <div class="action-group">
              <button type="button" class="ghost" (click)="goToDetail(c.id); $event.stopPropagation()">
                <span class="material-icon">visibility</span>
                <span>Xem</span>
              </button>
              <button type="button" class="ghost" (click)="goToEdit(c.id); $event.stopPropagation()" *ngIf="collectionMeta()?.allowUpdate">
                <span class="material-icon">edit</span>
                <span>S·ª≠a</span>
              </button>
              <button type="button" class="ghost danger" (click)="deleteRow(c.id); $event.stopPropagation()" *ngIf="collectionMeta()?.allowDelete">
                <span class="material-icon">delete</span>
                <span>X√≥a</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Specialized product table -->
  <div class="table-wrapper" *ngIf="isProductCollection() && !isCategoryCollection() && !isEmpty()">
    <table class="product-table">
      <thead>
        <tr>
          <th class="select">
            <input type="checkbox" [checked]="allSelected()" (change)="toggleSelectAll($event.target.checked)" />
          </th>
          <th class="name-col">T√™n s·∫£n ph·∫©m</th>
          <th class="id-col">ID s·∫£n ph·∫©m</th>
          <th class="price-col" (click)="toggleSort('price')">Gi√°</th>
          <th class="stock-col">T·ªìn kho</th>
          <th class="actions">H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let p of filteredProductRows()" class="clickable-row" (click)="goToDetail(p.id)">
          <td class="select" (click)="$event.stopPropagation()">
            <input type="checkbox" [checked]="selected().has(p.id)" (change)="toggleSelectOne(p.id, $event.target.checked)" (click)="$event.stopPropagation()" />
          </td>
          <td class="name">{{ p.name || '‚Äî' }}</td>
          <td class="mono id-col">{{ p.id || '‚Äî' }}</td>
          <td class="price price-col">{{ p.price | currency:'VND':'symbol':'1.0-0' }}</td>
          <td class="stock-col">
            <span class="stock" [class.low]="(p.stock ?? 0) <= 0" [class.ok]="(p.stock ?? 0) > 0">
              {{ p.stock === null ? '‚Äî' : (p.stock | number) }}
            </span>
          </td>
          <td class="actions" (click)="$event.stopPropagation()">
            <div class="action-group">
              <button type="button" class="ghost" (click)="goToDetail(p.id); $event.stopPropagation()">
                <span class="material-icon">visibility</span>
                <span>Xem</span>
              </button>
              <button type="button" class="ghost" (click)="goToEdit(p.id); $event.stopPropagation()" *ngIf="collectionMeta()?.allowUpdate">
                <span class="material-icon">edit</span>
                <span>S·ª≠a</span>
              </button>
              <button type="button" class="ghost danger" (click)="deleteRow(p.id); $event.stopPropagation()" *ngIf="collectionMeta()?.allowDelete">
                <span class="material-icon">delete</span>
                <span>X√≥a</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Specialized order table -->
  <div class="table-wrapper" *ngIf="isOrderCollection() && !isEmpty()">
    <table class="order-table">
      <thead>
        <tr>
          <th class="order-number-col">M√£ ƒë∆°n h√†ng</th>
          <th class="customer-col">Kh√°ch h√†ng</th>
          <th class="date-col" (click)="toggleSort('createdAt')">Ng√†y ƒë·∫∑t</th>
          <th class="total-col">T·ªïng ti·ªÅn</th>
          <th class="payment-col">Thanh to√°n</th>
          <th class="status-col">Tr·∫°ng th√°i</th>
          <th class="actions">H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let order of filteredOrders()" class="clickable-row" (click)="goToDetail(order.orderNumber || order._id)">
          <td class="order-number mono">{{ order.orderNumber || order._id }}</td>
          <td class="customer">
            <div class="customer-info">
              <div class="customer-name">{{ order.customerInfo?.name || order.shippingAddress?.name || '‚Äî' }}</div>
              <div class="customer-phone">{{ order.customerInfo?.phone || order.shippingAddress?.phone || '‚Äî' }}</div>
            </div>
          </td>
          <td class="date">{{ order.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
          <td class="total">{{ order.pricing?.total || order.total || 0 | currency:'VND':'symbol':'1.0-0' }}</td>
          <td class="payment">
            <span class="payment-badge" [attr.data-method]="order.paymentMethod">
              {{ order.paymentMethod === 'cod' ? 'COD' : 
                 order.paymentMethod === 'card' ? 'Th·∫ª' :
                 order.paymentMethod === 'bank' ? 'CK' : 
                 order.paymentMethod === 'atm' ? 'ATM' :
                 order.paymentMethod === 'qr' ? 'QR' : (order.paymentMethod || '‚Äî') }}
            </span>
          </td>
          <td class="status">
            <span class="order-status-badge" 
                  [class.pending]="(order.status || '').toLowerCase().includes('pending')"
                  [class.processing]="(order.status || '').toLowerCase().includes('processing') || (order.status || '').toLowerCase().includes('confirmed')"
                  [class.shipping]="(order.status || '').toLowerCase().includes('shipping') || (order.status || '').toLowerCase().includes('giao')"
                  [class.delivered]="(order.status || '').toLowerCase().includes('delivered') || (order.status || '').toLowerCase().includes('completed')"
                  [class.cancelled]="(order.status || '').toLowerCase().includes('cancelled') || (order.status || '').toLowerCase().includes('h·ªßy')"
                  [class.returned]="(order.status || '').toLowerCase().includes('returned')">
              {{ translateOrderStatus(order.status) }}
            </span>
          </td>
          <td class="actions" (click)="$event.stopPropagation()">
            <div class="action-group">
              <button type="button" class="ghost" (click)="goToDetail(order.orderNumber || order._id); $event.stopPropagation()">
                <span class="material-icon">visibility</span>
                <span>Xem</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Generic table for other collections (not category, not product, not order) -->
  <!-- Messenger View for Pharmacist Chats -->
  <div class="messenger-container" *ngIf="isPharmacistChatCollection() && !isEmpty()">
    <!-- Left Sidebar: Chat List -->
    <div class="messenger-sidebar">
      <div class="messenger-header">
        <h3>ƒêo·∫°n chat</h3>
        <button type="button" class="icon-btn" title="T√¨m ki·∫øm">
          <span class="material-icon">search</span>
        </button>
      </div>
      <div class="chat-list">
        <div
          *ngFor="let chat of messengerChats()"
          class="chat-item"
          [class.active]="selectedChatId() === chat.id"
          (click)="selectChat(chat.id)"
        >
          <div class="chat-avatar">
            <span class="material-icon">person</span>
          </div>
          <div class="chat-info">
            <div class="chat-name-row">
              <span class="chat-name">{{ chat.customerName }}</span>
              <span class="chat-time">{{ chat.lastMessageTime }}</span>
            </div>
            <div class="chat-preview">
              <span class="chat-message">{{ chat.lastMessage }}</span>
              <span class="chat-badge" *ngIf="chat.messageCount > 0">{{ chat.messageCount }}</span>
            </div>
            <div class="chat-customer-info" (click)="goToDetail(chat.id); $event.stopPropagation()">
              <span class="material-icon">phone</span>
              <span>{{ chat.customerPhone || '‚Äî' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Main: Chat Window -->
    <div class="messenger-main">
      <ng-container *ngIf="selectedChatView(); else noChatSelected">
        <div class="chat-window">
          <!-- Chat Header -->
          <div class="chat-window-header">
            <div class="chat-window-user" (click)="goToDetail(selectedChatView()!.id)">
              <div class="chat-window-avatar">
                <span class="material-icon">person</span>
              </div>
              <div class="chat-window-user-info">
                <div class="chat-window-name">{{ selectedChatView()!.customerName }}</div>
                <div class="chat-window-status">
                  <span class="material-icon">phone</span>
                  <span>{{ selectedChatView()!.customerPhone || '‚Äî' }}</span>
                  <span class="status-badge" [class]="selectedChatView()!.statusClass">{{ selectedChatView()!.statusLabel }}</span>
                </div>
              </div>
            </div>
            <button type="button" class="icon-btn" title="T√πy ch·ªçn" (click)="goToDetail(selectedChatView()!.id)">
              <span class="material-icon">info</span>
            </button>
          </div>

          <!-- Messages Area -->
          <div class="chat-messages" #chatMessages>
            <div *ngFor="let message of selectedChatView()!.messages" class="message-wrapper" [class.message-user]="message.sender === 'user'" [class.message-pharmacist]="message.sender === 'pharmacist'" [class.message-system]="message.sender === 'system'">
              <div class="message-bubble" [class.message-file]="message.type === 'file'">
                <div *ngIf="message.type === 'file'" class="message-file-content">
                  <div class="file-icon-wrapper">
                    <span class="material-icon">attach_file</span>
                  </div>
                  <div class="file-info">
                    <div class="file-name">{{ message.fileName || 'File ƒë√≠nh k√®m' }}</div>
                    <div class="file-size">{{ formatFileSize(message.fileSize || 0) }}</div>
                  </div>
                  <a [href]="apiUrl + message.fileUrl" target="_blank" class="file-download" title="T·∫£i xu·ªëng">
                    <span class="material-icon">download</span>
                  </a>
                </div>
                <div *ngIf="message.type !== 'file'" class="message-content">{{ message.content }}</div>
                <div class="message-time">{{ message.timestamp }}</div>
              </div>
            </div>
            <div *ngIf="loadingChat()" class="loading-messages">
              <span class="material-icon">hourglass_empty</span>
              <span>ƒêang t·∫£i...</span>
            </div>
          </div>

          <!-- Input Area -->
          <div class="chat-input-area">
            <!-- Selected File Preview -->
            <div *ngIf="selectedFile()" class="file-preview">
              <span class="material-icon">attach_file</span>
              <span class="file-name">{{ selectedFile()!.name }}</span>
              <button type="button" class="remove-file-btn" (click)="removeSelectedFile()" title="X√≥a">
                <span class="material-icon">close</span>
              </button>
            </div>

            <!-- Emoji Picker -->
            <div *ngIf="showEmojiPicker()" class="emoji-picker">
              <div class="emoji-grid">
                <button
                  *ngFor="let emoji of commonEmojis"
                  type="button"
                  class="emoji-btn"
                  (click)="insertEmoji(emoji)"
                  [title]="emoji"
                >
                  {{ emoji }}
                </button>
              </div>
            </div>

            <div class="input-row">
              <button type="button" class="input-icon-btn" title="Emoji" (click)="toggleEmojiPicker()" [class.active]="showEmojiPicker()">
                <span class="material-icon">mood</span>
              </button>
              <input
                type="text"
                class="chat-input"
                placeholder="Nh·∫≠p tin nh·∫Øn..."
                [ngModel]="pharmacistReplyDraft()"
                (ngModelChange)="pharmacistReplyDraft.set($event)"
                (keydown.enter)="sendPharmacistReply()"
                [disabled]="sendingPharmacistReply()"
              />
              <input
                type="file"
                id="file-input"
                class="file-input-hidden"
                (change)="onFileSelected($event)"
                accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx"
              />
              <label for="file-input" class="input-icon-btn" title="ƒê√≠nh k√®m file (<5MB)">
                <span class="material-icon">attach_file</span>
              </label>
              <button
                type="button"
                class="send-btn"
                (click)="sendPharmacistReply()"
                [disabled]="sendingPharmacistReply() || (!pharmacistReplyDraft().trim() && !selectedFile())"
                title="G·ª≠i"
              >
                <span class="material-icon" *ngIf="!sendingPharmacistReply()">send</span>
                <span class="material-icon spinner" *ngIf="sendingPharmacistReply()">hourglass_empty</span>
              </button>
            </div>
          </div>
        </div>
      </ng-container>
      <ng-template #noChatSelected>
        <div class="no-chat-selected">
          <span class="material-icon">chat_bubble_outline</span>
          <p>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ xem</p>
        </div>
      </ng-template>
    </div>
  </div>

  <ng-container *ngIf="!isCategoryCollection() && !isProductCollection() && !isOrderCollection() && !isPharmacistChatCollection()">
    <div class="table-wrapper" *ngIf="!isEmpty()">
      <table>
        <thead>
          <tr>
            <th *ngFor="let column of columns()" (click)="toggleSort(column)">
              <span>{{ column }}</span>
              <span class="sort" *ngIf="sortBy() === column">
                <span class="material-icon">{{ sortDir() === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</span>
              </span>
            </th>
            <th class="actions">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of items(); trackBy: trackById" class="clickable-row" (click)="goToDetail(row._id || row.orderNumber)">
            <td *ngFor="let column of columns()">{{ formatCell(row[column]) }}</td>
            <td class="actions" (click)="$event.stopPropagation()">
              <div class="action-group">
                <button type="button" class="ghost" (click)="goToDetail(row._id || row.orderNumber); $event.stopPropagation()">
                  <span class="material-icon">visibility</span>
                  <span>Xem</span>
                </button>
                <button type="button" class="ghost" (click)="goToEdit(row._id || row.orderNumber); $event.stopPropagation()" *ngIf="collectionMeta()?.allowUpdate">
                  <span class="material-icon">edit</span>
                  <span>S·ª≠a</span>
                </button>
                <button type="button" class="ghost danger" (click)="deleteRow(row._id || row.orderNumber); $event.stopPropagation()" *ngIf="collectionMeta()?.allowDelete">
                  <span class="material-icon">delete</span>
                  <span>X√≥a</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-container *ngIf="isEmpty()">
      <ng-container *ngTemplateOutlet="emptyState"></ng-container>
    </ng-container>
  </ng-container>

  <div class="pagination" *ngIf="pagination().pages > 1">
    <button type="button" (click)="changePage(pagination().page - 1)" [disabled]="pagination().page <= 1">
      <span class="material-icon">chevron_left</span>
      Tr∆∞·ªõc
    </button>
    <span>Trang</span>
    <input class="page-input" type="number" [min]="1" [max]="pagination().pages" [ngModel]="pageInput()" (ngModelChange)="onPageInput($event)" (keyup.enter)="goToPage()" />
    <span class="page-separator">/</span>
    <span class="page-total">{{ pagination().pages }}</span>
    <button
      type="button"
      (click)="changePage(pagination().page + 1)"
      [disabled]="pagination().page >= pagination().pages"
    >
      Sau
      <span class="material-icon">chevron_right</span>
    </button>
  </div>

  <div class="loading" *ngIf="loading()">
    <span class="spinner"></span>
    <span>ƒêang t·∫£i d·ªØ li·ªáu...</span>
  </div>
</section>

<!-- Create Voucher Modal -->
<div class="modal-overlay" *ngIf="showCreateVoucherModal()" (click)="closeCreateVoucherModal()">
  <div class="voucher-create-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <span class="material-icon">add_circle</span>
        T·∫°o m√£ gi·∫£m gi√° m·ªõi
      </h3>
      <button type="button" class="close-btn" (click)="closeCreateVoucherModal()">
        <span class="material-icon">close</span>
      </button>
    </div>

    <form [formGroup]="voucherForm" (ngSubmit)="submitVoucherForm()" class="modal-form">
      <div class="form-section">
        <h4>Th√¥ng tin c∆° b·∫£n</h4>
        <div class="form-grid">
          <label class="full-width">
            <span class="label-text">
              <span class="material-icon">confirmation_number</span>
              M√£ gi·∫£m gi√° <span class="required">*</span>
            </span>
            <input 
              type="text" 
              formControlName="code" 
              placeholder="VD: WELCOME10"
              [class.error]="voucherForm.get('code')?.invalid && voucherForm.get('code')?.touched"
            />
            <small *ngIf="voucherForm.get('code')?.invalid && voucherForm.get('code')?.touched" class="error-msg">
              M√£ ph·∫£i l√† ch·ªØ in hoa v√† s·ªë, kh√¥ng c√≥ kho·∫£ng tr·∫Øng
            </small>
          </label>

          <label class="full-width">
            <span class="label-text">
              <span class="material-icon">title</span>
              Ti√™u ƒë·ªÅ <span class="required">*</span>
            </span>
            <input 
              type="text" 
              formControlName="title" 
              placeholder="VD: Ch√†o m·ª´ng kh√°ch h√†ng m·ªõi"
              [class.error]="voucherForm.get('title')?.invalid && voucherForm.get('title')?.touched"
            />
          </label>

          <label class="full-width">
            <span class="label-text">
              <span class="material-icon">description</span>
              M√¥ t·∫£
            </span>
            <textarea 
              formControlName="description" 
              rows="3"
              placeholder="M√¥ t·∫£ v·ªÅ m√£ gi·∫£m gi√°..."
            ></textarea>
          </label>
        </div>
      </div>

      <div class="form-section">
        <h4>Th√¥ng tin gi·∫£m gi√°</h4>
        <div class="form-grid">
          <label>
            <span class="label-text">
              <span class="material-icon">percent</span>
              Ph·∫ßn trƒÉm gi·∫£m gi√° (%) <span class="required">*</span>
            </span>
            <input 
              type="number" 
              formControlName="discountPercent" 
              min="0" 
              max="100"
              placeholder="0"
              [class.error]="voucherForm.get('discountPercent')?.invalid && voucherForm.get('discountPercent')?.touched"
            />
          </label>

          <label>
            <span class="label-text">
              <span class="material-icon">attach_money</span>
              Gi·∫£m gi√° c·ªë ƒë·ªãnh (‚Ç´)
            </span>
            <input 
              type="number" 
              formControlName="discount" 
              min="0"
              placeholder="ƒê·ªÉ tr·ªëng n·∫øu d√πng ph·∫ßn trƒÉm"
            />
            <small class="hint">ƒê·ªÉ tr·ªëng n·∫øu ch·ªâ d√πng ph·∫ßn trƒÉm</small>
          </label>

          <label>
            <span class="label-text">
              <span class="material-icon">shopping_cart</span>
              ƒê∆°n h√†ng t·ªëi thi·ªÉu (‚Ç´)
            </span>
            <input 
              type="number" 
              formControlName="minOrderAmount" 
              min="0"
              placeholder="0"
            />
            <small class="hint">0 = kh√¥ng gi·ªõi h·∫°n</small>
          </label>

          <label>
            <span class="label-text">
              <span class="material-icon">repeat</span>
              S·ªë l∆∞·ª£t s·ª≠ d·ª•ng t·ªëi ƒëa
            </span>
            <input 
              type="number" 
              formControlName="maxUsage" 
              min="1"
              placeholder="ƒê·ªÉ tr·ªëng = kh√¥ng gi·ªõi h·∫°n"
            />
            <small class="hint">ƒê·ªÉ tr·ªëng = kh√¥ng gi·ªõi h·∫°n</small>
          </label>
        </div>
      </div>

      <div class="form-section">
        <h4>Th·ªùi gian √°p d·ª•ng</h4>
        <div class="form-grid">
          <label>
            <span class="label-text">
              <span class="material-icon">event</span>
              Ng√†y b·∫Øt ƒë·∫ßu
            </span>
            <input 
              type="datetime-local" 
              formControlName="startsAt"
            />
            <small class="hint">ƒê·ªÉ tr·ªëng = ngay l·∫≠p t·ª©c</small>
          </label>

          <label>
            <span class="label-text">
              <span class="material-icon">event_busy</span>
              Ng√†y h·∫øt h·∫°n
            </span>
            <input 
              type="datetime-local" 
              formControlName="expiresAt"
            />
            <small class="hint">ƒê·ªÉ tr·ªëng = kh√¥ng h·∫øt h·∫°n</small>
          </label>
        </div>
      </div>

      <div class="form-section">
        <label class="checkbox-label">
          <input type="checkbox" formControlName="isActive" />
          <span>K√≠ch ho·∫°t m√£ gi·∫£m gi√° ngay sau khi t·∫°o</span>
        </label>
      </div>

      <div class="modal-actions">
        <button type="button" class="ghost" (click)="closeCreateVoucherModal()" [disabled]="creatingVoucher()">
          H·ªßy
        </button>
        <button type="submit" class="primary" [disabled]="creatingVoucher() || voucherForm.invalid">
          <span class="material-icon" *ngIf="!creatingVoucher()">save</span>
          <span class="spinner" *ngIf="creatingVoucher()"></span>
          {{ creatingVoucher() ? 'ƒêang t·∫°o...' : 'T·∫°o m√£ gi·∫£m gi√°' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Import Data Modal -->
<div class="modal-overlay" *ngIf="showImportModal()" (click)="closeImportModal()">
  <div class="modal import-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <span class="material-icon">upload_file</span>
        Nh·∫≠p d·ªØ li·ªáu t·ª´ file
      </h3>
      <button type="button" class="close-btn" (click)="closeImportModal()">
        <span class="material-icon">close</span>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="import-instructions">
        <h4>H∆∞·ªõng d·∫´n nh·∫≠p d·ªØ li·ªáu</h4>
        <ol>
          <li>Chu·∫©n b·ªã file CSV v·ªõi c√°c c·ªôt t∆∞∆°ng ·ª©ng v·ªõi tr∆∞·ªùng d·ªØ li·ªáu</li>
          <li>D√≤ng ƒë·∫ßu ti√™n ph·∫£i l√† t√™n c√°c c·ªôt (headers)</li>
          <li>File ph·∫£i c√≥ ƒë·ªãnh d·∫°ng UTF-8 ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng ti·∫øng Vi·ªát</li>
          <li>M·ªói d√≤ng ti·∫øp theo l√† m·ªôt b·∫£n ghi d·ªØ li·ªáu</li>
        </ol>
        
        <div class="example-format">
          <h5>V√≠ d·ª• ƒë·ªãnh d·∫°ng CSV:</h5>
          <pre>name,price,stock,sku
S·∫£n ph·∫©m A,100000,50,SKU001
S·∫£n ph·∫©m B,200000,30,SKU002</pre>
        </div>
      </div>
      
      <div class="upload-area">
        <input 
          type="file" 
          accept=".csv" 
          id="importFile" 
          (change)="onImportFileSelected($event)"
          style="display: none;"
        />
        <label for="importFile" class="upload-label">
          <span class="material-icon">cloud_upload</span>
          <span class="upload-text">Ch·ªçn file CSV ƒë·ªÉ nh·∫≠p</span>
          <span class="upload-hint">K√©o th·∫£ file ho·∫∑c click ƒë·ªÉ ch·ªçn</span>
        </label>
      </div>
      
      <div class="import-warning">
        <span class="material-icon">warning</span>
        <p>L∆∞u √Ω: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá s·∫Ω b·ªã b·ªè qua. Qu√° tr√¨nh nh·∫≠p c√≥ th·ªÉ m·∫•t v√†i ph√∫t v·ªõi file l·ªõn.</p>
      </div>
    </div>
    
    <div class="modal-actions">
      <button type="button" class="ghost" (click)="closeImportModal()">
        ƒê√≥ng
      </button>
    </div>
  </div>
</div>

<ng-template #emptyState>
  <div class="empty">
    <span class="material-icon">inventory_2</span>
    <p>Ch∆∞a c√≥ d·ªØ li·ªáu cho t√†i nguy√™n n√†y</p>
    <button type="button" class="ghost" (click)="goToCreate()" *ngIf="collectionMeta()?.allowCreate">
      <span class="material-icon">add_circle</span>
      Th√™m b·∫£n ghi ƒë·∫ßu ti√™n
    </button>
  </div>
</ng-template>

<ng-template #missingCollection>
  <div class="empty missing">
    <span class="material-icon">report_problem</span>
    <p>Kh√¥ng t√¨m th·∫•y t√†i nguy√™n y√™u c·∫ßu ho·∫∑c ch∆∞a ƒë∆∞·ª£c ph√¢n quy·ªÅn.</p>
    <a routerLink="/dashboard">Quay l·∫°i dashboard</a>
  </div>
</ng-template>

