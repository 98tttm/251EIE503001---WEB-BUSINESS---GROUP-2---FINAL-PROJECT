<div class="admin-order-create">
  <header class="page-header">
    <div class="header-content">
      <a routerLink="/collections/orders" class="back-link">
        <span class="material-icon">arrow_back</span>
        Quay l·∫°i ƒë∆°n h√†ng
      </a>
      <div class="header-title">
        <h1>
          <span class="icon">üõí</span>
          T·∫°o ƒë∆°n h√†ng m·ªõi
        </h1>
        <p>T·∫°o ƒë∆°n h√†ng cho kh√°ch h√†ng v·ªõi quy·ªÅn admin</p>
      </div>
    </div>
  </header>

  <div class="order-layout" *ngIf="!loading(); else loadingState">
    <form [formGroup]="orderForm" (ngSubmit)="submitOrder()" class="order-form">
      
      <!-- Customer Information -->
      <section class="form-section">
        <div class="section-header">
          <h2>
            <span class="material-icon">person</span>
            Th√¥ng tin kh√°ch h√†ng
          </h2>
        </div>
        
        <div class="form-grid">
          <div class="form-field">
            <label>
              T√™n kh√°ch h√†ng <span class="required">*</span>
            </label>
            <input 
              type="text" 
              formControlName="customerName"
              placeholder="Nguy·ªÖn VƒÉn A"
              [class.error]="orderForm.get('customerName')?.invalid && orderForm.get('customerName')?.touched"
            />
            <span class="error-message" *ngIf="orderForm.get('customerName')?.invalid && orderForm.get('customerName')?.touched">
              Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng
            </span>
          </div>

          <div class="form-field">
            <label>
              S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span>
            </label>
            <input 
              type="tel" 
              formControlName="customerPhone"
              placeholder="0987654321"
              [class.error]="orderForm.get('customerPhone')?.invalid && orderForm.get('customerPhone')?.touched"
            />
            <span class="error-message" *ngIf="orderForm.get('customerPhone')?.invalid && orderForm.get('customerPhone')?.touched">
              S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (10 s·ªë)
            </span>
          </div>

          <div class="form-field full-width">
            <label>Email (t√πy ch·ªçn)</label>
            <input 
              type="email" 
              formControlName="customerEmail"
              placeholder="email@example.com"
              [class.error]="orderForm.get('customerEmail')?.invalid && orderForm.get('customerEmail')?.touched"
            />
            <span class="error-message" *ngIf="orderForm.get('customerEmail')?.invalid && orderForm.get('customerEmail')?.touched">
              Email kh√¥ng h·ª£p l·ªá
            </span>
          </div>
        </div>
      </section>

      <!-- Shipping Address -->
      <section class="form-section">
        <div class="section-header">
          <h2>
            <span class="material-icon">local_shipping</span>
            ƒê·ªãa ch·ªâ giao h√†ng
          </h2>
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [checked]="sameAsCustomer()"
              (change)="toggleSameAsCustomer()"
            />
            <span>Gi·ªëng th√¥ng tin kh√°ch h√†ng</span>
          </label>
        </div>

        <div class="form-grid">
          <div class="form-field">
            <label>
              Ng∆∞·ªùi nh·∫≠n <span class="required">*</span>
            </label>
            <input 
              type="text" 
              formControlName="shippingName"
              placeholder="Nguy·ªÖn VƒÉn A"
              [class.error]="orderForm.get('shippingName')?.invalid && orderForm.get('shippingName')?.touched"
            />
          </div>

          <div class="form-field">
            <label>
              S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span>
            </label>
            <input 
              type="tel" 
              formControlName="shippingPhone"
              placeholder="0987654321"
              [class.error]="orderForm.get('shippingPhone')?.invalid && orderForm.get('shippingPhone')?.touched"
            />
          </div>

          <div class="form-field">
            <label>
              T·ªânh/Th√†nh ph·ªë <span class="required">*</span>
            </label>
            <select 
              formControlName="province"
              (change)="onProvinceChange($any($event.target).value)"
              [class.error]="orderForm.get('province')?.invalid && orderForm.get('province')?.touched"
            >
              <option value="">Ch·ªçn t·ªânh/th√†nh</option>
              <option *ngFor="let p of provinces()" [value]="p.code">{{ p.name }}</option>
            </select>
          </div>

          <div class="form-field">
            <label>
              Qu·∫≠n/Huy·ªán <span class="required">*</span>
            </label>
            <select 
              formControlName="district"
              (change)="onDistrictChange($any($event.target).value)"
              [class.error]="orderForm.get('district')?.invalid && orderForm.get('district')?.touched"
              [disabled]="!orderForm.get('province')?.value || loadingDistricts()"
            >
              <option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>
              <option *ngFor="let d of districts()" [value]="d.code">{{ d.name }}</option>
            </select>
          </div>

          <div class="form-field">
            <label>
              Ph∆∞·ªùng/X√£ <span class="required">*</span>
            </label>
            <select 
              formControlName="ward"
              [class.error]="orderForm.get('ward')?.invalid && orderForm.get('ward')?.touched"
              [disabled]="!orderForm.get('district')?.value || loadingWards()"
            >
              <option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>
              <option *ngFor="let w of wards()" [value]="w.code">{{ w.name }}</option>
            </select>
          </div>

          <div class="form-field full-width">
            <label>
              ƒê·ªãa ch·ªâ c·ª• th·ªÉ <span class="required">*</span>
            </label>
            <textarea 
              formControlName="shippingAddress"
              placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..."
              rows="2"
              [class.error]="orderForm.get('shippingAddress')?.invalid && orderForm.get('shippingAddress')?.touched"
            ></textarea>
          </div>
        </div>
      </section>

      <!-- Products Selection -->
      <section class="form-section">
        <div class="section-header">
          <h2>
            <span class="material-icon">shopping_bag</span>
            S·∫£n ph·∫©m
          </h2>
          <span class="count-badge">{{ selectedProducts().length }} s·∫£n ph·∫©m</span>
        </div>

        <!-- Product Search -->
        <div class="product-search">
          <div class="search-input-wrapper">
            <span class="material-icon">search</span>
            <input 
              type="text"
              [value]="productSearchTerm()"
              (input)="onProductSearchInput($event)"
              placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m theo t√™n, SKU..."
              (focus)="showProductSearch.set(true)"
            />
            <span class="spinner" *ngIf="searchingProduct()"></span>
          </div>

          <!-- Search Results -->
          <div class="search-results" *ngIf="showProductSearch() && products().length > 0">
            <div 
              class="product-result-item"
              *ngFor="let product of products()"
              (click)="addProduct(product)"
            >
              <img 
                [src]="product.image || '/assets/images/no-image.png'" 
                [alt]="product.name"
                class="product-image"
              />
              <div class="product-info">
                <div class="product-name">{{ product.name }}</div>
                <div class="product-meta">
                  <span class="product-price">{{ product.finalPrice || product.price | number }}ƒë</span>
                  <span class="product-stock" [class.low]="product.stock <= 10">
                    C√≤n {{ product.stock }} sp
                  </span>
                </div>
              </div>
              <button type="button" class="add-btn">
                <span class="material-icon">add_circle</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Selected Products -->
        <div class="selected-products">
          <div class="empty-products" *ngIf="selectedProducts().length === 0">
            <span class="material-icon">shopping_cart</span>
            <p>Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</p>
            <small>T√¨m ki·∫øm v√† th√™m s·∫£n ph·∫©m v√†o ƒë∆°n h√†ng</small>
          </div>

          <div class="product-list" *ngIf="selectedProducts().length > 0">
            <div 
              class="product-item"
              *ngFor="let item of selectedProducts()"
            >
              <img 
                [src]="item.image || '/assets/images/no-image.png'"
                [alt]="item.productName"
                class="product-image"
              />
              <div class="product-details">
                <div class="product-name">{{ item.productName }}</div>
                <div class="product-price">{{ item.price | number }}ƒë</div>
              </div>
              <div class="quantity-controls">
                <button 
                  type="button"
                  class="qty-btn"
                  (click)="updateQuantity(item.productId, item.quantity - 1)"
                >
                  <span class="material-icon">remove</span>
                </button>
                <input 
                  type="number"
                  class="qty-input"
                  [value]="item.quantity"
                  (change)="updateQuantity(item.productId, +$any($event.target).value)"
                  min="1"
                />
                <button 
                  type="button"
                  class="qty-btn"
                  (click)="updateQuantity(item.productId, item.quantity + 1)"
                >
                  <span class="material-icon">add</span>
                </button>
              </div>
              <div class="item-total">
                {{ item.price * item.quantity | number }}ƒë
              </div>
              <button 
                type="button"
                class="remove-btn"
                (click)="removeProduct(item.productId)"
              >
                <span class="material-icon">delete</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Payment & Notes -->
      <section class="form-section">
        <div class="section-header">
          <h2>
            <span class="material-icon">payment</span>
            Thanh to√°n & Ghi ch√∫
          </h2>
        </div>

        <div class="form-grid">
          <div class="form-field full-width">
            <label>
              Ph∆∞∆°ng th·ª©c thanh to√°n <span class="required">*</span>
            </label>
            <div class="payment-methods">
              <label 
                *ngFor="let method of paymentMethods"
                class="payment-method"
                [class.selected]="orderForm.get('paymentMethod')?.value === method.value"
              >
                <input 
                  type="radio"
                  formControlName="paymentMethod"
                  [value]="method.value"
                />
                <span class="method-icon">{{ method.icon }}</span>
                <span class="method-label">{{ method.label }}</span>
              </label>
            </div>
          </div>

          <div class="form-field full-width">
            <label>Ghi ch√∫ kh√°ch h√†ng</label>
            <textarea 
              formControlName="customerNotes"
              placeholder="Ghi ch√∫ t·ª´ kh√°ch h√†ng..."
              rows="2"
            ></textarea>
          </div>

          <div class="form-field full-width">
            <label>Ghi ch√∫ n·ªôi b·ªô (Admin)</label>
            <textarea 
              formControlName="adminNotes"
              placeholder="Ghi ch√∫ n·ªôi b·ªô cho ƒë∆°n h√†ng..."
              rows="2"
            ></textarea>
          </div>
        </div>
      </section>
    </form>

    <!-- Order Summary Sidebar -->
    <aside class="order-summary">
      <div class="summary-card">
        <h3>T√≥m t·∫Øt ƒë∆°n h√†ng</h3>

        <div class="summary-row">
          <span>T·∫°m t√≠nh</span>
          <span class="value">{{ subtotal() | number }}ƒë</span>
        </div>

        <div class="summary-row">
          <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
          <span class="value">{{ shippingFee() | number }}ƒë</span>
        </div>

        <!-- Promotion -->
        <div class="promotion-section">
          <div class="promotion-header">
            <span class="material-icon">local_offer</span>
            <span>M√£ gi·∫£m gi√°</span>
          </div>

          <div class="applied-promotion" *ngIf="appliedPromotion()">
            <div class="promo-info">
              <span class="promo-code">{{ appliedPromotion()!.code }}</span>
              <span class="promo-discount">-{{ discount() | number }}ƒë</span>
            </div>
            <button 
              type="button"
              class="remove-promo"
              (click)="removePromotion()"
            >
              <span class="material-icon">close</span>
            </button>
          </div>

          <div class="available-promotions" *ngIf="!appliedPromotion() && promotions().length > 0">
            <button 
              *ngFor="let promo of promotions()"
              type="button"
              class="promo-item"
              (click)="applyPromotion(promo)"
              [disabled]="promo.minOrderAmount > subtotal()"
            >
              <div class="promo-code">{{ promo.code }}</div>
              <div class="promo-desc">Gi·∫£m {{ promo.discountPercent }}%</div>
            </button>
          </div>
        </div>

        <div class="summary-row discount" *ngIf="discount() > 0">
          <span>Gi·∫£m gi√°</span>
          <span class="value">-{{ discount() | number }}ƒë</span>
        </div>

        <div class="summary-row total">
          <span>T·ªïng c·ªông</span>
          <span class="value">{{ total() | number }}ƒë</span>
        </div>

        <button 
          type="submit"
          class="submit-btn"
          (click)="submitOrder()"
          [disabled]="submitting() || orderForm.invalid || selectedProducts().length === 0"
        >
          <span class="material-icon" *ngIf="!submitting()">check_circle</span>
          <span class="spinner" *ngIf="submitting()"></span>
          <span>{{ submitting() ? 'ƒêang t·∫°o...' : 'T·∫°o ƒë∆°n h√†ng' }}</span>
        </button>

        <button 
          type="button"
          class="cancel-btn"
          routerLink="/collections/orders"
          [disabled]="submitting()"
        >
          H·ªßy b·ªè
        </button>
      </div>
    </aside>
  </div>
</div>

<ng-template #loadingState>
  <div class="loading-state">
    <span class="spinner"></span>
    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
  </div>
</ng-template>

