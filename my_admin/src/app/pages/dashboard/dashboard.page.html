<section class="dashboard" *ngIf="summary(); else loadingState">
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-title">
        <h2>
          <span class="dashboard-icon">üìä</span>
          T·ªïng quan ho·∫°t ƒë·ªông
        </h2>
        <p>·∫¢nh h∆∞·ªüng to√†n h·ªá th·ªëng trong 30 ng√†y g·∫ßn nh·∫•t ‚Ä¢ C·∫≠p nh·∫≠t l√∫c {{ currentTime() }}</p>
      </div>
      <div class="header-actions">
        <button type="button" class="toggle-view" (click)="toggleViewMode()">
          <span class="material-icon">{{ viewMode() === 'simple' ? 'bar_chart' : 'table_chart' }}</span>
          <span>{{ viewMode() === 'simple' ? 'Xem tr·ª±c quan' : 'Xem ƒë∆°n gi·∫£n' }}</span>
        </button>
        <button type="button" class="refresh" (click)="refresh()" [disabled]="loading()">
          <span class="material-icon">autorenew</span>
          <span>C·∫≠p nh·∫≠t</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Quick Actions Panel -->
  <section class="quick-actions">
    <h3 class="section-title">
      <span class="material-icon">flash_on</span>
      Thao t√°c nhanh
    </h3>
    <div class="actions-grid">
      <button type="button" class="action-card" routerLink="/collections/products/new">
        <div class="action-icon products">
          <span class="material-icon">add_shopping_cart</span>
        </div>
        <div class="action-content">
          <span class="action-title">Th√™m s·∫£n ph·∫©m</span>
          <span class="action-desc">T·∫°o s·∫£n ph·∫©m m·ªõi</span>
        </div>
      </button>

      <button type="button" class="action-card" routerLink="/collections/categories/new">
        <div class="action-icon categories">
          <span class="material-icon">add_box</span>
        </div>
        <div class="action-content">
          <span class="action-title">Th√™m danh m·ª•c</span>
          <span class="action-desc">T·∫°o danh m·ª•c m·ªõi</span>
        </div>
      </button>

      <button type="button" class="action-card" routerLink="/collections/orders">
        <div class="action-icon orders">
          <span class="material-icon">receipt_long</span>
        </div>
        <div class="action-content">
          <span class="action-title">Qu·∫£n l√Ω ƒë∆°n h√†ng</span>
          <span class="action-desc">{{ orderStats().pending || 0 }} ƒë∆°n ch·ªù x·ª≠ l√Ω</span>
        </div>
      </button>

      <button type="button" class="action-card special" routerLink="/admin/create-order">
        <div class="action-icon create-order">
          <span class="material-icon">add_shopping_cart</span>
        </div>
        <div class="action-content">
          <span class="action-title">ƒê·∫∑t h√†ng d√πm kh√°ch</span>
          <span class="action-desc">T·∫°o ƒë∆°n h√†ng m·ªõi</span>
        </div>
      </button>

      <button type="button" class="action-card" routerLink="/collections/promotions/new">
        <div class="action-icon promotions">
          <span class="material-icon">local_offer</span>
        </div>
        <div class="action-content">
          <span class="action-title">T·∫°o khuy·∫øn m√£i</span>
          <span class="action-desc">Th√™m m√£ gi·∫£m gi√°</span>
        </div>
      </button>

      <button type="button" class="action-card" routerLink="/collections/blogs/new">
        <div class="action-icon blogs">
          <span class="material-icon">post_add</span>
        </div>
        <div class="action-content">
          <span class="action-title">Vi·∫øt b√†i m·ªõi</span>
          <span class="action-desc">Th√™m b√†i vi·∫øt blog</span>
        </div>
      </button>

      <button type="button" class="action-card" routerLink="/collections/users">
        <div class="action-icon users">
          <span class="material-icon">people</span>
        </div>
        <div class="action-content">
          <span class="action-title">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</span>
          <span class="action-desc">Xem danh s√°ch user</span>
        </div>
      </button>
    </div>
  </section>

  <section class="stat-cards">
    <article
      class="card"
      *ngFor="let item of totalsCards(); index as i"
      [class.accent-blue]="item.accent === 'accent-blue'"
      [class.accent-indigo]="item.accent === 'accent-indigo'"
      [class.accent-rose]="item.accent === 'accent-rose'"
      [class.accent-emerald]="item.accent === 'accent-emerald'"
      [class.accent-purple]="item.accent === 'accent-purple'"
      [class.accent-amber]="item.accent === 'accent-amber'"
      [class.clickable]="!!item.link"
      (click)="navigateTo(item.link)"
      (keydown)="handleCardKeydown($event, item.link)"
      [attr.tabindex]="item.link ? 0 : null"
      [attr.role]="item.link ? 'button' : null"
      [attr.aria-label]="item.link ? 'ƒêi t·ªõi ' + item.label : null"
    >
      <div class="icon">
        <span class="material-icon">{{ item.icon }}</span>
      </div>
      <div class="meta">
        <span class="label">{{ item.label }}</span>
        <span class="value">{{ item.value | number }}</span>
      </div>
    </article>
  </section>

  <!-- Simple View -->
  <section class="grid" *ngIf="viewMode() === 'simple'">
    <article class="panel revenue">
      <div class="panel-header">
        <div>
          <h3>Doanh thu 30 ng√†y</h3>
          <p>G·ªìm ƒë∆°n giao th√†nh c√¥ng &amp; ho√†n t·∫•t</p>
        </div>
      </div>
      <div class="chart" *ngIf="revenueSeries().length; else revenueEmpty">
        <div class="bars">
          <div
            class="bar-wrapper"
            *ngFor="let point of revenueSeries()"
          >
            <div
              class="bar"
              [style.--height]="getBarHeight(point.total)"
              [title]="(point.total | currency:'VND':'symbol':'1.0-0') + ' - ' + (point.day | date:'dd/MM')"
            >
              <span class="tooltip">
                <strong>{{ point.day | date: 'dd/MM' }}</strong>
                <span>{{ point.total | currency: 'VND':'symbol':'1.0-0' }}</span>
                <small>{{ point.orders }} ƒë∆°n</small>
              </span>
            </div>
            <span class="bar-label">{{ point.day | date: 'dd/MM' }}</span>
          </div>
        </div>
        <div class="chart-footer">
          <span>ƒê·ªânh: {{ maxRevenue() | currency: 'VND':'symbol':'1.0-0' }}</span>
          <span>T·ªïng ƒëi·ªÉm d·ªØ li·ªáu: {{ revenueSeries().length }}</span>
        </div>
      </div>
      <ng-template #revenueEmpty>
        <div class="empty">Ch∆∞a c√≥ d·ªØ li·ªáu doanh thu</div>
      </ng-template>
    </article>

    <article class="panel status">
      <div class="panel-header">
        <div>
          <h3>Tr·∫°ng th√°i ƒë∆°n h√†ng</h3>
          <p>Ph√¢n b·ªï theo s·ªë l∆∞·ª£ng ƒë∆°n</p>
        </div>
      </div>
      <ul class="status-list" *ngIf="ordersByStatus().length; else statusEmpty">
        <li *ngFor="let row of ordersByStatus()">
          <div class="info">
            <span class="name">{{ row._id || 'Kh√¥ng x√°c ƒë·ªãnh' }}</span>
            <span class="count">{{ row.count | number }}</span>
          </div>
          <div class="progress">
            <div class="fill" [style.width.%]="(row.count / (ordersByStatus()[0]?.count || 1)) * 100"></div>
          </div>
        </li>
      </ul>
      <ng-template #statusEmpty>
        <div class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu tr·∫°ng th√°i ƒë∆°n h√†ng</div>
      </ng-template>
    </article>
  </section>

  <section class="grid details" *ngIf="viewMode() === 'simple'">
    <article class="panel">
      <div class="panel-header">
        <div>
          <h3>ƒê∆°n h√†ng g·∫ßn ƒë√¢y</h3>
          <p>8 ƒë∆°n h√†ng m·ªõi nh·∫•t trong h·ªá th·ªëng</p>
        </div>
        <a routerLink="/collections/orders">Xem t·∫•t c·∫£</a>
      </div>
      <div class="table" *ngIf="recentOrders().length; else ordersEmpty">
        <table>
          <thead>
            <tr>
              <th>M√£ ƒë∆°n</th>
              <th>Kh√°ch h√†ng</th>
              <th>Tr·∫°ng th√°i</th>
              <th>T·ªïng ti·ªÅn</th>
              <th>Ng√†y t·∫°o</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let order of recentOrders()">
              <td>{{ order.orderNumber || order._id }}</td>
              <td>{{ order.customerInfo?.name || order.shippingAddress?.name || '·∫®n danh' }}</td>
              <td><span class="badge">{{ order.status || 'unknown' }}</span></td>
              <td>{{ order.pricing?.total | currency: 'VND':'symbol':'1.0-0' }}</td>
              <td>{{ order.createdAt | date: 'dd/MM/yyyy HH:mm' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #ordersEmpty>
        <div class="empty">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</div>
      </ng-template>
    </article>

    <article class="panel">
      <div class="panel-header">
        <div>
          <h3>Ng∆∞·ªùi d√πng m·ªõi</h3>
          <p>8 t√†i kho·∫£n v·ª´a ƒëƒÉng k√Ω ho·∫∑c k√≠ch ho·∫°t</p>
        </div>
        <a routerLink="/collections/users">Xem t·∫•t c·∫£</a>
      </div>
      <div class="table" *ngIf="recentUsers().length; else usersEmpty">
        <table>
          <thead>
            <tr>
              <th>T√™n</th>
              <th>Email</th>
              <th>S·ªë ƒëi·ªán tho·∫°i</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Ng√†y t·∫°o</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of recentUsers()">
              <td>{{ user.profile?.name || user.mail || user.phone }}</td>
              <td>{{ user.mail || '‚Äî' }}</td>
              <td>{{ user.phone || '‚Äî' }}</td>
              <td><span class="badge status" [class.active]="user.status === 'active'">{{ user.status || 'unknown' }}</span></td>
              <td>{{ user.createdAt | date: 'dd/MM/yyyy HH:mm' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #usersEmpty>
        <div class="empty">Ch∆∞a c√≥ ng∆∞·ªùi d√πng m·ªõi</div>
      </ng-template>
    </article>
  </section>

  <section class="panel top-categories" *ngIf="viewMode() === 'simple'">
    <div class="panel-header">
      <div>
        <h3>Danh m·ª•c b√°n ch·∫°y</h3>
        <p>Top 8 danh m·ª•c c√≥ nhi·ªÅu s·∫£n ph·∫©m v√† doanh thu cao</p>
      </div>
      <a routerLink="/collections/categories">Qu·∫£n l√Ω danh m·ª•c</a>
    </div>
    <div class="table" *ngIf="topCategories().length; else categoryEmpty">
      <table>
        <thead>
          <tr>
            <th>Danh m·ª•c</th>
            <th>S·ªë s·∫£n ph·∫©m</th>
            <th>Doanh thu ∆∞·ªõc t√≠nh</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of topCategories()">
            <td>{{ item.category?.name || item._id || 'Kh√¥ng x√°c ƒë·ªãnh' }}</td>
            <td>{{ item.products | number }}</td>
            <td>{{ item.totalRevenue | currency: 'VND':'symbol':'1.0-0' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #categoryEmpty>
      <div class="empty">Ch∆∞a c√≥ s·ªë li·ªáu danh m·ª•c</div>
    </ng-template>
  </section>

  <!-- Visual View with Charts -->
  <section class="visual-dashboard" *ngIf="viewMode() === 'visual'">
    <div class="charts-grid">
      <article class="chart-panel large">
        <div class="panel-header">
          <div>
            <h3>Bi·ªÉu ƒë·ªì doanh thu 30 ng√†y</h3>
            <p>Xu h∆∞·ªõng doanh thu theo th·ªùi gian</p>
          </div>
        </div>
        <div class="chart-container">
          <canvas #revenueChart></canvas>
        </div>
      </article>

      <article class="chart-panel">
        <div class="panel-header">
          <div>
            <h3>Ph√¢n b·ªï tr·∫°ng th√°i ƒë∆°n</h3>
            <p>T·ª∑ l·ªá ƒë∆°n h√†ng theo tr·∫°ng th√°i</p>
          </div>
        </div>
        <div class="chart-container">
          <canvas #statusChart></canvas>
        </div>
      </article>

      <article class="chart-panel">
        <div class="panel-header">
          <div>
            <h3>S·ªë l∆∞·ª£ng ƒë∆°n h√†ng</h3>
            <p>Th·ªëng k√™ ƒë∆°n h√†ng 30 ng√†y</p>
          </div>
        </div>
        <div class="chart-container">
          <canvas #ordersChart></canvas>
        </div>
      </article>

      <article class="chart-panel full-width">
        <div class="panel-header">
          <div>
            <h3>Top danh m·ª•c b√°n ch·∫°y</h3>
            <p>Doanh thu theo danh m·ª•c s·∫£n ph·∫©m</p>
          </div>
        </div>
        <div class="chart-container">
          <canvas #categoryChart></canvas>
        </div>
      </article>
    </div>

    <!-- Key Insights Section -->
    <div class="insights-section">
      <h3 class="insights-title">
        <span class="material-icon">lightbulb</span>
        Ph√¢n t√≠ch Insight
      </h3>
      <div class="insights-grid">
        <article class="insight-card" *ngIf="revenueSeries().length > 0">
          <div class="insight-icon revenue">
            <span class="material-icon">trending_up</span>
          </div>
          <div class="insight-content">
            <h4>Doanh thu trung b√¨nh</h4>
            <p class="insight-value">{{ averageRevenue() | currency: 'VND':'symbol':'1.0-0' }}</p>
            <p class="insight-desc">Trung b√¨nh m·ªói ng√†y trong 30 ng√†y qua</p>
          </div>
        </article>

        <article class="insight-card" *ngIf="ordersByStatus().length > 0">
          <div class="insight-icon orders">
            <span class="material-icon">shopping_cart</span>
          </div>
          <div class="insight-content">
            <h4>T·ªïng ƒë∆°n h√†ng</h4>
            <p class="insight-value">{{ totalOrders() | number }}</p>
            <p class="insight-desc">T·∫•t c·∫£ ƒë∆°n h√†ng trong h·ªá th·ªëng</p>
          </div>
        </article>

        <article class="insight-card" *ngIf="topCategory()">
          <div class="insight-icon category">
            <span class="material-icon">star</span>
          </div>
          <div class="insight-content">
            <h4>Danh m·ª•c h√†ng ƒë·∫ßu</h4>
            <p class="insight-value">{{ topCategory()?.category?.name || 'N/A' }}</p>
            <p class="insight-desc">{{ topCategory()?.totalRevenue | currency: 'VND':'symbol':'1.0-0' }} doanh thu</p>
          </div>
        </article>

        <article class="insight-card" *ngIf="revenueSeries().length > 1">
          <div class="insight-icon growth">
            <span class="material-icon">analytics</span>
          </div>
          <div class="insight-content">
            <h4>TƒÉng tr∆∞·ªüng</h4>
            <p class="insight-value" 
               [class.positive]="revenueGrowth() > 0"
               [class.negative]="revenueGrowth() <= 0">
              {{ revenueGrowth() | number:'1.0-1' }}%
            </p>
            <p class="insight-desc">So v·ªõi ƒë·∫ßu k·ª≥ 30 ng√†y</p>
          </div>
        </article>
      </div>
    </div>
  </section>
</section>

<ng-template #loadingState>
  <div class="loading-state">
    <span class="spinner"></span>
    <span>ƒêang t·∫£i d·ªØ li·ªáu qu·∫£n tr·ªã...</span>
  </div>
</ng-template>

